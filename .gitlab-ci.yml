stages:
  - build
  - release

variables:
  GIT_STRATEGY: clone
  ELECTRON_BUILDER_CACHE: "/root/.cache/electron-builder"

build_app:
  image: electronuserland/builder:wine
  stage: build
  script:
    - echo "NEXT_PUBLIC_API_BASE_URL=$API_BASE_URL" > renderer/.env.local
    - echo "GITLAB_PERSONAL_ACCESS_TOKEN=$GITLAB_PERSONAL_ACCESS_TOKEN" > renderer/.env.local
    - yarn install --frozen-lockfile
    - yarn nextron build --win --ia32 --x64
    - ls -lah dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 day

release:
  image: electronuserland/builder:wine
  stage: release
  script:
    - echo "NEXT_PUBLIC_API_BASE_URL=$API_BASE_URL" > renderer/.env.local
    - echo "GITLAB_PERSONAL_ACCESS_TOKEN=$GITLAB_PERSONAL_ACCESS_TOKEN" > renderer/.env.local
    - export GITLAB_TOKEN=$GITLAB_PERSONAL_ACCESS_TOKEN
    - yarn install --frozen-lockfile
    - yarn nextron build --win --ia32 --x64 --publish never
    - ls -lah dist/

    # Buat rilis GitLab dengan artifacts
    - |
      curl --request POST --header "PRIVATE-TOKEN: $GITLAB_PERSONAL_ACCESS_TOKEN" \
        --data "name=Release $CI_COMMIT_TAG" \
        --data "tag_name=$CI_COMMIT_TAG" \
        --data "description=Automated release for $CI_COMMIT_TAG" \
        --data "assets[links][][name]=Download Artifacts" \
        --data "assets[links][][url]=$CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/download" \
        "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/releases"

  artifacts:
    paths:
      - dist/
  only:
    - tags
